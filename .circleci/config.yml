version: 2.1

# Define reusable commands
commands:
  install_uv:
    description: "Install uv package manager"
    steps:
      - run:
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> "$BASH_ENV"
            source "$BASH_ENV"
            uv --version

  setup_python_dependencies:
    description: "Install Python dependencies"
    steps:
      - install_uv
      - run:
          name: Install dependencies with uv
          command: |
            uv sync
      - run:
          name: Verify Python version
          command: |
            python --version
            python -c "import sys; print(f'Python {sys.version}')"

  build_cython_extensions:
    description: "Build Cython extensions"
    steps:
      - run:
          name: Clean previous builds
          command: |
            rm -rf build/
            find cython/ -name "*.so" -delete 2>/dev/null || true
            find cython/ -name "*.c" -delete 2>/dev/null || true
            find cython/ -name "*.cpp" -delete 2>/dev/null || true
      - run:
          name: Build Cython extensions
          command: |
            python build.py build_ext --inplace
      - run:
          name: List compiled extensions
          command: |
            echo "Compiled extensions:"
            find cython/ virtmanager_cython/ -name "*.so" -exec echo "  - {}" \; 2>/dev/null || true
            find . -name "*.so" -exec echo "  - {}" \; 2>/dev/null || true

  run_tests:
    description: "Run all tests"
    steps:
      - run:
          name: Run Cython tests
          command: |
            python test_cython.py
      - run:
          name: Check for additional test files
          command: |
            if [ -d "tests" ]; then
              echo "Found tests directory, running pytest..."
              python -m pip install pytest || uv add --dev pytest
              python -m pytest tests/ -v || echo "pytest failed or no tests found"
            else
              echo "No tests directory found, skipping pytest"
            fi

  store_artifacts:
    description: "Store build artifacts"
    steps:
      - run:
          name: Store build artifacts
          command: |
            mkdir -p ~/artifacts/build
            cp -r build/* ~/artifacts/build/
      - run:
          name: Generate HTML annotations (if available)
          command: |
            if [ -d "build/cython" ]; then
              echo "HTML annotation files found:"
              find build/cython -name "*.html" -exec echo "  - {}" \;
            else
              echo "No HTML annotation files generated"
            fi
      - run:
          name: Store cython annotations
          command: |
            mkdir -p ~/artifacts/cython
            cp -r build/cython/* ~/artifacts/cython/

# Define jobs
jobs:
  # Main build and test job
  build_and_test:
    docker:
      - image: cimg/python:3.12  # Using 3.12 since 3.14 might not be available
    working_directory: ~/project
    steps:
      - checkout
      - setup_python_dependencies
      - build_cython_extensions
      - run_tests
      - store_artifacts
      - run:
          name: Build summary
          command: |
            echo "=== Build Summary ==="
            echo "Python version: $(python --version)"
            echo "Working directory: $(pwd)"
            echo "Compiled extensions:"
            find . -name "*.so" -exec echo "  {}" \; 2>/dev/null || echo "  No .so files found"
            echo "Build completed successfully!"

  # Code quality checks (optional)
  code_quality:
    docker:
      - image: cimg/python:3.12
    working_directory: ~/project
    steps:
      - checkout
      - install_uv
      - run:
          name: Install development dependencies
          command: |
            uv add --dev black isort flake8 mypy || true
      - run:
          name: Code formatting check
          command: |
            if command -v black &> /dev/null; then
              black --check . || echo "Black formatting check failed"
            else
              echo "Black not available, skipping formatting check"
            fi
      - run:
          name: Import sorting check
          command: |
            if command -v isort &> /dev/null; then
              isort --check-only . || echo "isort check failed"
            else
              echo "isort not available, skipping import sorting check"
            fi
      - run:
          name: Linting
          command: |
            if command -v flake8 &> /dev/null; then
              flake8 --max-line-length=88 --extend-ignore=E203,W503 . || echo "flake8 linting failed"
            else
              echo "flake8 not available, skipping linting"
            fi

  # Multi-platform build (Linux)
  build_linux:
    docker:
      - image: cimg/python:3.12
    working_directory: ~/project
    steps:
      - checkout
      - setup_python_dependencies
      - build_cython_extensions
      - run_tests
      - run:
          name: Platform-specific build info
          command: |
            echo "=== Linux Build Info ==="
            uname -a
            python --version
            find . -name "*.so" -exec file {} \; 2>/dev/null || echo "No .so files found"

  # Test with different Python versions (if available)
  test_python_311:
    docker:
      - image: cimg/python:3.11
    working_directory: ~/project
    steps:
      - checkout
      - run:
          name: Update pyproject.toml for Python 3.11
          command: |
            # Temporarily modify Python requirement for testing
            sed -i 's/>=3.14/>=3.11/' pyproject.toml || echo "Could not modify pyproject.toml"
      - setup_python_dependencies
      - build_cython_extensions
      - run_tests

# Define workflows
workflows:
  version: 2

  # Main workflow - runs on all commits
  build_and_test_workflow:
    jobs:
      - build_and_test
      - code_quality:
          requires:
            - build_and_test

  # Comprehensive workflow - runs on main branch and tags
  comprehensive_test:
    jobs:
      - build_and_test:
          filters:
            branches:
              only:
                - main
                - master
                - develop
            tags:
              only: /.*/
      - build_linux:
          requires:
            - build_and_test
          filters:
            branches:
              only:
                - main
                - master
                - develop
            tags:
              only: /.*/
      - test_python_311:
          requires:
            - build_and_test
          filters:
            branches:
              only:
                - main
                - master
                - develop
      - code_quality:
          requires:
            - build_and_test
          filters:
            branches:
              only:
                - main
                - master
                - develop

  # Nightly build workflow
  nightly:
    triggers:
      - schedule:
          cron: "0 2 * * *"  # Run at 2 AM UTC daily
          filters:
            branches:
              only:
                - main
                - master
    jobs:
      - build_and_test
      - build_linux:
          requires:
            - build_and_test
      - code_quality:
          requires:
            - build_and_test
